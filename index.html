<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pikachu Offline</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111">

<style>
html,body{
  margin:0;
  padding:0;
  background:#111;
  overflow:hidden;
  font-family:sans-serif;
}

#gameWrapper{
  position:fixed;
  top:1in;
  bottom:1in;
  left:1in;
  right:1in;
  display:flex;
  flex-direction:column;
}

#hud{
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:white;
  font-size:18px;
  margin-bottom:10px;
}

#canvasContainer{
  flex:1;
  position:relative;
}

canvas{
  background:#222;
  width:100%;
  height:100%;
  touch-action:none;
}

button{
  padding:8px 14px;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

#startScreen, #gameOver{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.85);
  flex-direction:column;
  color:white;
  z-index:10;
}

.hidden{ display:none; }

#hintBtn{
  background:#f39c12;
}
</style>
</head>
<body>

<div id="gameWrapper">

  <div id="hud">
    <div>‚è± <span id="time">60</span></div>
    <div>üéØ Level: <span id="level">1</span></div>
    <div>‚≠ê ƒêi·ªÉm: <span id="score">0</span></div>
    <div>
      <button id="hintBtn">G·ª£i √Ω (10)</button>
      <button onclick="restart()">Ch∆°i l·∫°i</button>
    </div>
  </div>

  <div id="canvasContainer">
    <canvas id="gameCanvas"></canvas>

    <div id="startScreen">
      <button onclick="startGame()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="gameOver" class="hidden">
      <h2>H·∫æT GI·ªú</h2>
      <button onclick="restart()">CH∆†I L·∫†I</button>
    </div>
  </div>
</div>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');

let rows=8, cols=12;
let board=[];
let selected=[];
let tileSize;
let time=60;
let timerInterval;
let score=0;
let level=1;
let hintLeft=10;
let frozen=true;

function resize(){
  canvas.width=canvas.offsetWidth;
  canvas.height=canvas.offsetHeight;
  tileSize=Math.min(canvas.width/cols, canvas.height/rows);
}
window.addEventListener('resize',resize);
resize();

function createBoard(){
  board=[];
  let total=rows*cols;
  let values=[];
  for(let i=1;i<=total/2;i++){
    values.push(i%20+1);
    values.push(i%20+1);
  }
  values.sort(()=>Math.random()-0.5);

  for(let r=0;r<rows;r++){
    let row=[];
    for(let c=0;c<cols;c++){
      row.push(values.pop());
    }
    board.push(row);
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(board[r][c]){
        ctx.drawImage(
          images[board[r][c]],
          c*tileSize,
          r*tileSize,
          tileSize,
          tileSize
        );
      }
    }
  }
}

canvas.addEventListener('click',e=>{
  if(frozen) return;

  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  const c=Math.floor(x/tileSize);
  const r=Math.floor(y/tileSize);

  if(!board[r] || !board[r][c]) return;

  selected.push({r,c});
  if(selected.length==2){
    checkMatch();
  }
});

function drawLine(p1,p2){
  ctx.strokeStyle="orange";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(p1.c*tileSize+tileSize/2,p1.r*tileSize+tileSize/2);
  ctx.lineTo(p2.c*tileSize+tileSize/2,p2.r*tileSize+tileSize/2);
  ctx.stroke();
}

function checkMatch(){
  let a=selected[0];
  let b=selected[1];

  if(board[a.r][a.c]==board[b.r][b.c]){
    drawLine(a,b);
    setTimeout(()=>{
      board[a.r][a.c]=0;
      board[b.r][b.c]=0;
      score+=10;
      updateHUD();
      selected=[];
      draw();
    },400);
  }else{
    selected=[];
  }
}

function updateHUD(){
  document.getElementById('time').innerText=time;
  document.getElementById('score').innerText=score;
  document.getElementById('level').innerText=level;
  document.getElementById('hintBtn').innerText="G·ª£i √Ω ("+hintLeft+")";
}

function startTimer(){
  timerInterval=setInterval(()=>{
    if(time<=0){
      clearInterval(timerInterval);
      showAutoHint();
      setTimeout(()=>{
        document.getElementById('gameOver').classList.remove('hidden');
        frozen=true;
      },3000);
    }else{
      time--;
      updateHUD();
    }
  },1000);
}

function startGame(){
  document.getElementById('startScreen').classList.add('hidden');
  createBoard();
  draw();
  time=60;
  score=0;
  hintLeft=10;
  frozen=false;
  updateHUD();
  startTimer();
}

function restart(){
  clearInterval(timerInterval);
  document.getElementById('gameOver').classList.add('hidden');
  startGame();
}

document.getElementById('hintBtn').onclick=()=>{
  if(hintLeft<=0 || frozen) return;
  hintLeft--;
  showAutoHint();
  updateHUD();
};

function showAutoHint(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      for(let r2=0;r2<rows;r2++){
        for(let c2=0;c2<cols;c2++){
          if(r!=r2||c!=c2){
            if(board[r][c] && board[r][c]==board[r2][c2]){
              drawLine({r,c},{r:r2,c:c2});
              setTimeout(draw,3000);
              return;
            }
          }
        }
      }
    }
  }
}

const images={};
for(let i=1;i<=20;i++){
  const img=new Image();
  img.src="images/"+i+".png";
  images[i]=img;
}
</script>
</body>
</html>
